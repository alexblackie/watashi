<p>
	Alternatively, &ldquo;<em>How is <code>dnf</code> the only package manager that actually works??</em>&rdquo;
</p>

<p>
	For a while now I have done all my dayjob work within a VM over SSH and
	Samba. This has worked quite well, and meant I could keep my development
	environment a bit more slow-moving (generally, the latest Ubuntu LTS) while
	running a faster-moving desktop distribution on the hardware itself. It
	also means when I travel I can <code>rsync</code> the VM to my personal
	laptop and not have to lug two laptops with me everywhere just to keep that
	work/personal separation.
</p>

<p>
	<strong>So. I tried to install updates</strong>. About halfway through
	installing updates, something I do a couple times a week usually, the VM
	froze. The SSH connection was responsive but I could tell all disk I/O was
	totally dead, and basically nothing worked -- not even closing a shell
	session. I opened the VM's console display and sure enough there was a
	screen full of watchdog warnings saying the Kernel had hung. I gave it a
	couple minutes but it seemed clear that something had gone horribly wrong.
</p>

<p>
	I forced off the VM and rebooted, which thankfully worked fine. So then I
	tried to resume the upgrade.
</p>

<p>
	<code>apt</code>, of course, was no help.
</p>

<div class="code">
	<div class="code-title">~ % sudo apt update</div>
<pre><code>Hit:1 http://archive.ubuntu.com/ubuntu bionic InRelease
Hit:2 http://archive.ubuntu.com/ubuntu bionic-security InRelease
Hit:3 http://archive.ubuntu.com/ubuntu bionic-updates InRelease
Reading package lists... Done
Building dependency tree
Reading state information... Done
All packages are up to date.</code></pre></div>

<p>
	As always, make sure to notice and laugh out loud when you see the proud
	<code>http://</code> plastered across your screen, knowing that even if you
	added an <code>s</code> it would not work because Canonical do not provide
	secure package mirrors, and unless you installed some extension package
	(over plain HTTP of course) <code>apt</code> doesn't even support secure
	connections.
</p>

<p>
	<code>All packages are up to date.</code> Um, well, that's entirely false.
	As soon as I saw this I knew I was in for a wild ride, and started thinking
	through how much work it would be to just rebuild the VM from scratch.
</p>

<p>
	I lost my shell history for this part but I had to eventually find out to
	run some <code>dpkg</code> command to "resume" the in-flight upgrade:
</p>

<pre><code>dpkg --configure --some-other-flags-i-think</code></pre>

<p>
	That did a bunch of stuff, seemingly finished the upgrade successfully.
</p>

<p>
	&ldquo;Well, let's just try again!&rdquo;
</p>

<div class="code">
	<div class="code-title">~ % sudo apt dist-upgrade</div>
<pre><code>Reading package lists... Done
Building dependency tree
Reading state information... Done
E: The package libgl1-mesa-dri needs to be reinstalled, but I can't find an archive for it.</code></pre></div>

<p>
	There it is - upgrading this package is what hosed the system to begin
	with. Good to see there is at least a problem being logged somewhere.
</p>

<p>
	I first tried <code>apt reinstall</code> which I always forget does not
	exist. I moved on to just trying to remove and install it myself&hellip;
</p>

<div class="code">
	<div class="code-title">~ % sudo apt remove libgl1-mesa-dri</div>
<pre><code>Reading package lists... Done
Building dependency tree
Reading state information... Done
E: The package libgl1-mesa-dri needs to be reinstalled, but I can't find an archive for it.</code></pre></div>

<p>
	Yes&hellip; Thanks, I know&hellip; &ldquo;Sorry, we can't remove this package
	because we can't find a locally cached tarball to upgrade it, and
	apparently aren't smart enough to figure out how to just redownload it from
	the repo"&hellip;
</p>

<p>
	With my hope dwindling, I finally tried the old <code>install -f</code>,
	which works when you install a <code>deb</code> manually, which often
	requires you to temporarily break your system until you <code>install -f</code>.
	Installing a <code>deb</code> is a hilariously shitty process but that's
	not the topic for today's discussion.
</p>

<div class="code">
	<div class="code-title">~ % sudo apt install -f</div>
<pre><code>Reading package lists... Done
Building dependency tree
Reading state information... Done
E: The package libgl1-mesa-dri needs to be reinstalled, but I can't find an archive for it.</code></pre></div>

<p>
	It did not work.
</p>

<p>
	My patience growing thin I finally resorted to copying and pasting the
	error into a search engine, which so far is the only benefit to running
	Ubuntu I can come up with.
</p>

<p>
	StackOverflow, of course, delivered.
</p>

<div class="code">
	<div class="code-title">~ % sudo dpkg --remove --force-all libgl1-mesa-dri</div>
<pre><code> dpkg: libgl1-mesa-dri:amd64: dependency problems, but removing anyway as you requested:
 libglx-mesa0:amd64 depends on libgl1-mesa-dri.

 dpkg: warning: overriding problem because --force enabled:
 dpkg: warning: package is in a very bad inconsistent state; you should
  reinstall it before attempting a removal
  (Reading database ... 166745 files and directories currently installed.)
  Removing libgl1-mesa-dri:amd64 (18.2.8-0ubuntu0~18.04.2) ...</code></pre></div>

<p>
	<code>dpkg</code>, of course, complains and moans about doing the literal
	one and only solution to fixing the problem that it caused in the first
	place. But does do as asked, and removes the broken package from the
	system.
</p>

<p>
	Now I can finally just run <code>apt install --fix-broken</code> which
	installed some random other packages I guess that were required. At this
	point I am so tired of debugging this problem I do not care.
</p>

<p>
	I can now run <code>apt</code> again, and running a subsequent <code>apt upgrade</code> was successful.
</p>

<p>
	After all of this, I just cannot help but think about <code>dnf</code> and
	how none of this would have happened if the package manager in Debian was
	built well and fully integrated. This split-brain between <code>apt</code>
	and <code>dpkg</code>, with the user having to juggle a bunch of
	non-memorable flags and commands for both just to figure out what the hell
	is going on, let alone to repair a system. This also leads into one tool
	not understanding the state of the other, leading to the situation of this
	entire post.
</p>

<p>
	I have experienced failed upgrades in Fedora! It has happened! But because
	<code>dnf</code> is good software, it gracefully knows a previous
	transaction was aborted and offers to resume it, or lets you roll it back
	safely, or at least lets you see what is going on with your system and what
	problems you might run into because of the failure.
</p>

<p>
	But don't worry:
</p>

<div class="code">
	<div class="code-title">~ % apt -h</div>
<pre><code>[...]

This APT has Super Cow Powers.</code></pre></div>

<p>
	However, apparently "super cow powers" are not enough to safely install
	package updates.
</p>

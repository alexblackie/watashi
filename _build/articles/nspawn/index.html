<!doctype html>
<html lang="en-CA">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<title>Quick and Dirty Containers with systemd &mdash; Alex Blackie</title>
<link rel="stylesheet" href="/_/site.css" type="text/css">
<link rel="stylesheet" href="/_/code.css" type="text/css">
<link rel="alternate" type="application/rss+xml" title="Alex Blackie's Blog" href="/feed.xml">





<script async defer data-domain="alexblackie.com" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
<div class="siteMain">
<header class="siteHeader">
<h1>
<a class="siteHeader--brandLink" href="/">
<img src="/_/avi.jpg" alt="Avatar of Alex Blackie." width="46" height="46"><br>
<span>
Alex Blackie<br>
<em>The Internet Sensation&trade;</em>
</span>
</a>
</h1>

<input id="mobileHeaderToggle" type="checkbox" role="button" title="Toggle Menu">
<label id="mobileHeaderToggleIcon" for="mobileHeaderToggle"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></label>

<div class="mobileCollapsed">
<nav class="siteMenu">
<a class="active" href="/articles"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-book"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg> Articles</a>
<a class="" href="/setup/"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-monitor"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg> My Setup</a>
<a class="" href="/about/"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg> About Me</a>
</nav>
</div>
</header>

<div class="siteContent">
<div class="articleOldWarning withAside">
<aside>
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-alert-circle"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
</aside>
<p class="besideAside">
<strong>This article is over two years old.</strong> Life moves
quickly, and thus there is a good chance any references,
recommendations, or opinions in this content are out of date. Make sure
to verify any information independently.
</p>
</div>
<article class="singleArticle">
<header class="singleArticle--header">
<h1>Quick and Dirty Containers with systemd</h1>
<div class="singleArticle--header--meta">Published July 22 2015 </div>
</header>



<div class="singleArticle--body">
			<p>
  Docker and other containerization technologies are making the rounds in the
  Linux community, but a lowly hero lurks beneath now every major Linux
  distro; enter <code>systemd-nspawn</code> containers.
</p>

<p>
  systemd has arrived with mixed reviews -- you either love it or you hate it
  -- but one thing stands for certain: it gets the job done. Regardless of
  your emotions projected towards it, systemd is likely here to stay for a
  while, so you might as well exploit as many features as you can out of it.
</p>

<p>
  <code>systemd-nspawn</code> containers are akin to FreeBSD Jails more than
  Docker containers. They&#39;re basically just a fancy <code>chroot</code>
  with some handy built-in integrations with systemd. You can start, stop,
  enable, and disable the containers as if they were regular services.
</p>

<p>
  Keep in mind, however, that by its own admission,
  <code>systemd-nspawn</code> is an experimental feature that hasn&#39;t been
  thoroughly tested or audited. There are no guarantees of security or
  stability; it&#39;s probably best to keep them out of production for the
  time being. That said, here at BlackieOps we&#39;ve been using
  <code>systemd-nspawn</code> containers for Jenkins, Stash, and Jira for a
  while now without any issues.
</p>

<h3>Creating the container</h3>

<p>
  We will be working on a fresh install of CentOS 7, but this process is
  possible on any system using systemd. The only difference will be the first
  package installation step. Obviously, on Debian you will not be using
  <code>yum</code>, and on Fedora your repo names and release versions will
  be different (and you&#39;ll be using <code>dnf</code>)&hellip;
</p>

<hr />

<p>
  First step is to &quot;install&quot; a new root filesystem into a
  directory.
</p>

<pre><code># yum -y --releasever=7 --nogpg --installroot=/var/lib/machines/cool-container   --disablerepo='*' --enablerepo=base install systemd passwd yum centos-release
</code></pre>

<p>
  This will create a directory,
  <code>/var/lib/machines/cool-container</code>, and populate it with a new root
  filesystem and a couple core packages.
</p>

<p>
  Second, we need to enter into the container to set up some basic things
  like the <code>root</code> password. We can use the
  <code>systemd-nspawn</code> command directly for this:
</p>

<pre><code># systemd-nspawn -D /var/lib/machines/cool-container</code></pre>

<p>
  This drops you to a shell in the container without actually
  &quot;booting&quot; anything inside of it (think of it as like
  <code>chroot</code>-ing from a recovery mode. From here, we can set the
  root password so we can log in later.
</p>

<p>
  When you&#39;re done, just <code>^D</code> out as usual and you&#39;ll be
  dropped back to your host machine.
</p>

<h3>Aside: kernel auditing and containers</h3>

<p>
  If you ignore this section and continue trying to boot the container, you
  will likely get a warning before the container starts about the kernel
  auditing subsystem. There are supposedly odd bugs that can surface if
  auditing is enabled, so we&#39;re just going to disable it. If this worries
  you, feel free to inspect the issue further, but since this is not a
  production system it&#39;s probably fine.
</p>

<p>
  We just need to add a flag to the kernel parameters in our bootloader. This
  will vary between distros, but for CentOS it&#39;s as easy as editing the
  <code>/etc/sysconfig/grub</code> file and changing the
  <code>GRUB_CMDLINE_LINUX</code> variable by appending <code>audit=0</code>
  to the list of parameters.
</p>

<p>
  After editing the parameters, we&#39;ll need to regenerate our GRUB
  configuration:
</p>

<pre><code># grub2-mkconfig -o /etc/grub2.cfg</code></pre>

<h3>Configuring the base system</h3>

<p>
  We now have a skeleton of a container installed, but we still need to
  actually configure what&#39;s inside of it, and get it prepped to start
  automatically, or at least as a service from systemd.
</p>

<p>
  Since we now have access to the <code>root</code> account, we can fully
  &quot;boot&quot; the container:
</p>

<pre><code># systemd-nspawn -bD /var/lib/machines/cool-container
</code></pre>

<p>
  The <code>-b</code> flag is short for <code>--boot</code> and basically
  means <code>systemd-nspawn</code> will search for an init binary and
  execute it. You&#39;ll see the standard boot log fly by, and then be
  dropped at a standard PTY login prompt. Log in with the root credentials
  you set up previously, and now we can start installing things as if we were
  on a brand new machine.
</p>

<p>
  Once you have your container set up and everything is running and
  configured, you can exit by &quot;shutting down&quot; the container as if
  it was a physical machine: <code>poweroff</code> or <code>halt</code> (or
  whatever you usually use).
</p>

<h3>Managing the container</h3>

<p>
  While the <code>/var/lib/machines</code> prefix at the beginning may have
  seemed arbitrary, in fact it was intentional -- containers in this
  directory will be auto-discovered by systemd and we can enable and manage
  them automatically.
</p>

<p>To have your container start with everything else when your host boots:</p>

<pre><code># systemctl enable systemd-nspawn@cool-container</code></pre>

<p>
  And as you can perhaps guess, we can start and stop our container just as
  any other service:
</p>

<pre><code># systemctl start systemd-nspawn@cool-container
# systemctl stop systemd-nspawn@cool-container</code></pre>

<h3>Accessing the container</h3>

<p>
  Accessing a running container can be a bit tricky; one option is to install
  <code>openssh</code> in the container and have it run on a non-standard
  port (as containers share the host&#39;s network interfaces).
  Alternatively, you can access the machine through <code>machinectl</code>.
</p>

<p>
  Just running <code>machinectl</code> without arguments will list all
  running containers (and other VMs, etc). Interestingly, the older version
  of <code>machinectl</code> on CentOS does not allow us to use the
  <code>login</code> argument (so you may want to install
  <code>openssh</code>)... If you&#39;re on Fedora (or a different more
  up-to-date distro), we can use <code>machinectl login</code> command:
</p>

<pre><code># machinectl login cool-container</code></pre>

<p>... which will drop us at that familiar PTY prompt.</p>

<p>
  Since we don&#39;t necessarily want to halt the container to escape from
  this prompt, there is a panic button to disconnect: hit escape three times
  within a second (i.e., fast).
</p>

<hr />

<p>
  In conclusion, <code>systemd-nspawn</code> is an interesting technology
  that shows promise.  Its ubiquity through the proliferation of systemd
  means containers are quite portable, easy to set up, and well-integrated
  directly into the OS&#39;s init system.
</p>

<p>
  Would I use it in production? Probably not. It&#39;s a very green
  technology and its immaturity is worrisome enough that my sleep cycles
  would be lessened dramatically by its deployment. For production
  &quot;containers&quot;, FreeBSD Jails still provide the best security and
  featureset.
</p>

<p>
  For now, <code>systemd-nspawn</code> is staying on my internal
  infrastructure, running my Atlassian stack, Jenkins, etc.; and it is
  running those internal services quite well. But until its features are more
  solidified and someone has verified it is at least moderately secure, it
  won&#39;t be finding its way to my production stack for a few years
  yet.
</p>
</div>
</article>
</div>
</div>

<footer	class="siteFooter mobileCollapsed">
<p>
&copy; 2013-2020 Alex Blackie. Some Rights Reserved.
</p>
<p>
This site is <a class="withIcon" href="https://github.com/alexblackie/watashi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg> open source</a>. Icons are from the wonderful <a href="https://feathericons.com">Feather Icons</a>.<br>
Powered by make, bash, Kubernetes, and significant quantities of coffee.
</p>
</footer>
</body>
</html>
